---
layout: post
title: Java 线程池浅析
categories: Java
tags: [java, 线程池]
---

# Java线程池

## 1 什么是线程池

线程池是一种基于池化思想管理线程的工具，常用于多线程服务。

池化思想：是为了最大化收益并最小化风险，而将资源统一管理的一种思想。

线程池解决的核心问题是：资源管理问题。

多线程并发场景下的问题：

1. 频繁创建、销毁资源，调度资源，会带来额外的消耗，可能会很巨大
2. 对资源申请缺少抑制手段，可能会引发系统资源耗尽；
3. 不能合理管理系统资源，会降低系统的稳定性。

使用线程池的好处：

1. 降低资源消耗
2. 提高响应速度
3. 提高线程的可管理性
4. 提供更强大的扩展功能

## 2 线程池的核心设计

线程池的核心实现类是TreaPoolExecutor，它实现的顶层接口是Executor，它提供了一种思想：<mark>将任务提交和任务执行解耦</mark>。

线程池内部实际上构建了一个生产者消费者模型：

- 生产者——任务管理，接收提交的任务，并处理任务的后续流转
- 消费者——线程管理，消费任务并执行

### 2.1 状态维护

状态：运行状态、线程数量

使用一个变量维护，ctl，AtomicInteger类型，高三位保存runState，低29位保存wokerCount。

这样做的优点：

1. <mark>用一个变量保存两个值，可以避免在做相关决策时出现不一致的的情况，不必为了维护两者的一致，而占用锁资源</mark>
2. 位运算相比于基本运算，速度快很多
3. 减少内存占用

五种状态：RUNNING, SHUTDOWN, STOP, TIDYING, TERMINATED

### 2.2 任务管理

**任务调度**

入口：execute()方法

todo： execute方法的流程

任务缓冲——阻塞队列

### 2.3 线程管理

任务申请：

1. 由新创建的线程执行，只在线程初次创建的时候出现
2. 空闲线程从任务队列中申请并获取任务执行，绝大部分任务的执行都是如此。

申请任务是通过getTask()方法实现的

未完待续……
